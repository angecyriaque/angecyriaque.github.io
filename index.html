<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite CRM - Business Management</title>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-global: #ffffff;
            --nav-bg: #1a237e;
            --nav-text: #ffffff;
            --active-bg: #ff4500;
            --active-text: #ffffff;
            --btn-gradient: linear-gradient(135deg, #1e3a8a, #3b82f6);
            --card-bg: #f8fafc;
            --text-main: #1e293b;
            --border-color: #e2e8f0;
            --status-subscriber: #10b981;
            --status-occasional: #ff4500;
            --status-out-of-stock: #f97316;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-global: #0f172a;
            --nav-bg: #020617;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --border-color: #334155;
            --btn-gradient: linear-gradient(135deg, #fb923c, #f97316);
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

        body {
            background-color: var(--bg-global);
            color: var(--text-main);
            transition: var(--transition);
            min-height: 100vh;
        }

        /* --- NAVIGATION --- */
        nav {
            background-color: var(--nav-bg);
            padding: 0 2rem;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .nav-links { display: flex; gap: 10px; height: 100%; align-items: center; }

        .nav-item {
            padding: 10px 20px;
            border-radius: 8px;
            color: var(--nav-text);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            opacity: 0.7;
        }

        .nav-item.active { background-color: var(--active-bg); color: var(--active-text); transform: translateY(-2px); opacity: 1; }

        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        /* --- LAYOUT --- */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }

        .search-wrapper { position: relative; flex: 1; max-width: 400px; }
        .search-wrapper input {
            width: 100%; padding: 12px 20px 12px 45px; border-radius: 30px;
            border: 1px solid var(--border-color); background: var(--card-bg);
            color: var(--text-main); outline: none; transition: var(--transition);
        }
        .search-wrapper input:focus { border-color: var(--active-bg); box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.2); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        .btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
            border-radius: 10px; border: none; color: white; font-weight: 600;
            cursor: pointer; background: var(--btn-gradient); transition: var(--transition);
        }
        .btn:hover { transform: scale(1.03); filter: brightness(1.1); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .btn-accent { background: var(--active-bg); }

        /* --- GRID & CARDS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .grid-articles { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }

        .card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 1.5rem; transition: var(--transition);
            cursor: pointer; position: relative; display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--active-bg); box-shadow: var(--shadow); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border-color); color: #64748b; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }

        .article-img-container {
            width: 100%; height: 120px; background: #e2e8f0; border-radius: 12px;
            margin-bottom: 10px; overflow: hidden; display: flex; align-items: center;
            justify-content: center; position: relative;
        }
        .article-img-container img { width: 100%; height: 100%; object-fit: cover; }

        .rupture-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .rupture-text {
            color: #ffffff; font-weight: 900; font-size: 1.2rem; letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); border: 2px solid #ffffff; padding: 4px 12px; transform: rotate(-15deg);
        }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; color: white; }
        .status-subscriber { background-color: var(--status-subscriber); }
        .status-occasional { background-color: var(--status-occasional); }
        .status-rupture { background-color: var(--status-out-of-stock); }
        .status-paid { background-color: #dcfce7; color: #16a34a; }
        .status-unpaid { background-color: #fee2e2; color: #dc2626; }

        .card-code { font-size: 0.75rem; color: #64748b; font-weight: 800; }
        .card-name { font-size: 1.1rem; font-weight: 700; margin: 0.5rem 0; }
        .card-info { font-size: 0.85rem; color: #64748b; display: grid; gap: 5px; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--bg-global); width: 95%; max-width: 650px;
            border-radius: 20px; padding: 2rem; max-height: 90vh; overflow-y: auto;
        }
        .modal-lg { max-width: 1000px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .full { grid-column: span 2; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; }
        input, select, textarea {
            width: 100%; padding: 10px; border-radius: 8px;
            border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main);
        }
        input:read-only { background-color: #f1f5f9; cursor: not-allowed; }

        .list-manager { background: #f1f5f9; padding: 10px; border-radius: 8px; margin-top: 5px; display: flex; gap: 5px; }

        /* --- TOAST --- */
        #toast {
            position: fixed; bottom: 20px; right: 20px; padding: 12px 24px;
            border-radius: 10px; color: white; transform: translateY(100px);
            transition: 0.3s; z-index: 3000; font-weight: 600;
        }
        #toast.show { transform: translateY(0); }
    </style>
</head>
<body>

    <nav>
        <div class="nav-links">
            <div class="nav-item active" id="tab-CLIENT" onclick="switchView('CLIENT')">
                <i data-lucide="users"></i> CLIENTS
            </div>
            <div class="nav-item" id="tab-FOURNISSEUR" onclick="switchView('FOURNISSEUR')">
                <i data-lucide="truck"></i> FOURNISSEURS
            </div>
            <div class="nav-item" id="tab-ARTICLE" onclick="switchView('ARTICLE')">
                <i data-lucide="package"></i> ARTICLES
            </div>
            <div class="nav-item" id="tab-VENTE" onclick="switchView('VENTE')">
                <i data-lucide="shopping-cart"></i> VENTES
            </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">
            <i data-lucide="moon"></i>
        </button>
    </nav>

    <div class="container">
        <div class="action-bar" id="action-bar-container">
            <div class="search-wrapper">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" id="searchInput" placeholder="Rechercher..." oninput="filterData()">
            </div>
            <div id="dynamic-buttons" style="display: flex; gap: 10px;">
                <button class="btn" onclick="exportData()">
                    <i data-lucide="download"></i> Exporter CSV
                </button>
                <button class="btn" onclick="openAddForm()">
                    <i data-lucide="plus-circle"></i> Nouveau <span id="btn-label">Client</span>
                </button>
            </div>
        </div>

        <div id="mainContent">
            <div class="grid" id="mainGrid"></div>
        </div>
    </div>

    <!-- Modal Formulaire Standard -->
    <div class="modal-overlay" id="formModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                <h2 id="modalTitle">Nouveau</h2>
                <button onclick="closeModal('formModal')" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            <form id="mainForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                
                <div id="fields-entity" class="form-grid">
                    <div class="form-group full">
                        <label>Nom Complet / Raison Sociale *</label>
                        <input type="text" id="formName">
                    </div>
                    <div class="form-group">
                        <label>Contact Principal *</label>
                        <input type="tel" id="formPhone1">
                    </div>
                    <div class="form-group">
                        <label>Contact Secondaire</label>
                        <input type="tel" id="formPhone2">
                    </div>
                    <div class="form-group full">
                        <label>Adresse Géographique *</label>
                        <input type="text" id="formAddress">
                    </div>
                    <div class="form-group">
                        <label>Statut *</label>
                        <select id="formStatus" onchange="toggleLimitField()">
                            <option value="Occasionnel">Occasionnel</option>
                            <option value="Abonné">Abonné</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Plafond Financier (FCFA) *</label>
                        <input type="number" id="formLimit">
                    </div>
                    <div class="form-group full">
                        <label>Adresse Mail</label>
                        <input type="email" id="formEmail">
                    </div>
                </div>

                <div id="fields-article" class="form-grid" style="display:none;">
                    <div class="form-group full">
                        <label>Nom de l'Article *</label>
                        <input type="text" id="artName">
                    </div>
                    <div class="form-group">
                        <label>Famille *</label>
                        <select id="artFamily"></select>
                        <div class="list-manager">
                            <input type="text" id="newFamily" placeholder="Nouvelle famille">
                            <button type="button" onclick="addListOption('artFamily', 'newFamily', 'families')" class="btn" style="padding:5px 10px;"><i data-lucide="plus"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Sous-Famille *</label>
                        <select id="artSubFamily"></select>
                        <div class="list-manager">
                            <input type="text" id="newSubFamily" placeholder="Nouvelle sous-famille">
                            <button type="button" onclick="addListOption('artSubFamily', 'newSubFamily', 'subfamilies')" class="btn" style="padding:5px 10px;"><i data-lucide="plus"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Prix Initial *</label>
                        <input type="number" id="artPrice" min="0" oninput="calculateArticleValues()">
                    </div>
                    <div class="form-group">
                        <label>Stock Initial *</label>
                        <input type="number" id="artStock" min="0" oninput="calculateArticleValues()">
                    </div>
                    <div class="form-group">
                        <label>Valeur Stock Initial (Auto)</label>
                        <input type="text" id="artStockVal" readonly>
                    </div>
                    <div class="form-group">
                        <label>Prix de Revient (Auto)</label>
                        <input type="text" id="artCostPrice" readonly>
                    </div>
                    <div class="form-group full">
                        <label>Photo d'illustration</label>
                        <input type="file" id="artPhoto" accept="image/*" onchange="handleImageUpload(this)">
                        <input type="hidden" id="artPhotoData">
                        <div id="photoPreview" style="margin-top:10px; height:100px; display:none;">
                            <img src="" id="previewImg" style="height:100%; border-radius:8px;">
                        </div>
                    </div>
                </div>

                <div style="margin-top:2rem; display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" class="btn" style="background:#94a3b8;" onclick="closeModal('formModal')">Annuler</button>
                    <button type="submit" class="btn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Vente / Devis (Placeholder pour fonctions futures) -->
    <div class="modal-overlay" id="saleModal">
        <div class="modal-content modal-lg">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                <h2 id="saleModalTitle">Création de Document</h2>
                <button onclick="closeModal('saleModal')" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            <p style="text-align:center; padding:3rem; opacity:0.6;">Interface d'édition de <span id="doc-type-label"></span> en cours de chargement...</p>
        </div>
    </div>

    <!-- Modal Détails -->
    <div class="modal-overlay" id="detailsModal">
        <div class="modal-content" id="detailsContainer"></div>
    </div>

    <!-- Modal Suppression -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <h2 style="color:#ef4444; margin-bottom:1rem;">Confirmer la suppression</h2>
            <p style="margin-bottom:1.5rem; font-size:0.9rem;">Saisissez le code administrateur pour valider.</p>
            <input type="password" id="adminCode" placeholder="Code Administrateur" style="text-align:center; margin-bottom:1rem;">
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn" style="background:#94a3b8;" onclick="closeModal('deleteModal')">Annuler</button>
                <button class="btn btn-danger" onclick="executeDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // --- ETAT GLOBAL ---
        let currentView = 'CLIENT';
        let families = JSON.parse(localStorage.getItem('crm_families')) || ["Electronique", "Bureau", "Divers"];
        let subfamilies = JSON.parse(localStorage.getItem('crm_subfamilies')) || ["Informatique", "Papeterie", "Autre"];
        
        let db = {
            CLIENT: JSON.parse(localStorage.getItem('crm_clients')) || [],
            FOURNISSEUR: JSON.parse(localStorage.getItem('crm_suppliers')) || [],
            ARTICLE: JSON.parse(localStorage.getItem('crm_articles')) || [],
            VENTE: JSON.parse(localStorage.getItem('crm_ventes')) || []
        };
        let deleteTargetId = null;

        // --- NAVIGATION ---
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`tab-${view}`).classList.add('active');
            
            const btnLabel = document.getElementById('btn-label');
            const grid = document.getElementById('mainGrid');
            const dynamicButtons = document.getElementById('dynamic-buttons');

            if (view === 'VENTE') {
                // Boutons spécifiques pour l'onglet Ventes
                dynamicButtons.innerHTML = `
                    <button class="btn btn-accent" onclick="openSaleForm('Devis')">
                        <i data-lucide="file-text"></i> DEVIS
                    </button>
                    <button class="btn" onclick="openSaleForm('Facture')">
                        <i data-lucide="receipt"></i> FACTURE
                    </button>
                `;
            } else {
                // Boutons standards pour les autres onglets
                if(btnLabel) btnLabel.textContent = view.toLowerCase();
                dynamicButtons.innerHTML = `
                    <button class="btn" onclick="exportData()">
                        <i data-lucide="download"></i> Exporter CSV
                    </button>
                    <button class="btn" onclick="openAddForm()">
                        <i data-lucide="plus-circle"></i> Nouveau <span id="btn-label">${view.toLowerCase()}</span>
                    </button>
                `;
            }
            
            if(view === 'ARTICLE') grid.classList.add('grid-articles');
            else grid.classList.remove('grid-articles');

            render();
        }

        // --- RENDER ---
        function render(data = db[currentView]) {
            const grid = document.getElementById('mainGrid');
            
            if (currentView === 'VENTE') {
                renderVentes(grid, data);
                return;
            }

            if (data.length === 0) {
                grid.innerHTML = `<div class="full" style="text-align:center; padding:4rem; opacity:0.5; grid-column: 1 / -1;">Aucun enregistrement dans ${currentView}.</div>`;
                return;
            }

            if (currentView === 'ARTICLE') {
                grid.innerHTML = data.map(item => `
                    <div class="card" onclick="showDetails('${item.id}')">
                        <div class="article-img-container">
                            ${item.photo ? `<img src="${item.photo}">` : `<i data-lucide="image" style="color:#94a3b8"></i>`}
                            ${item.stock <= 0 ? `<div class="rupture-overlay"><span class="rupture-text">RUPTURE</span></div>` : ''}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="card-code">${item.id}</span>
                            ${item.stock <= 0 ? `<span class="status-badge status-rupture">RUPTURE</span>` : ''}
                        </div>
                        <h3 class="card-name">${item.name}</h3>
                        <div class="card-info">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="color: #f97316; font-weight: 600;">${Number(item.stock).toLocaleString()} en stock</span>
                                <span style="color: var(--text-main); font-weight: 800;">${Number(item.price).toLocaleString()} FCFA</span>
                            </div>
                            <span style="font-size:0.75rem; color:#94a3b8;">${item.family} / ${item.subfamily}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = data.map(item => `
                    <div class="card" onclick="showDetails('${item.id}')">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="card-code">${item.id}</span>
                            <span class="status-badge ${item.status === 'Abonné' ? 'status-subscriber' : 'status-occasional'}">${item.status}</span>
                        </div>
                        <h3 class="card-name">${item.name}</h3>
                        <div class="card-info">
                            <span><i data-lucide="phone" size="14"></i> ${item.phone1}</span>
                            <span><i data-lucide="map-pin" size="14"></i> ${item.address}</span>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function renderVentes(container, data) {
            container.innerHTML = `
                <div class="card full" style="padding: 0; overflow-x: auto; grid-column: 1 / -1;">
                    <table>
                        <thead>
                            <tr>
                                <th>N°</th>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Type</th>
                                <th>Total (FCFA)</th>
                                <th>Reste</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.length === 0 ? '<tr><td colspan="8" style="text-align:center; padding:2rem; opacity:0.5;">Aucune vente enregistrée.</td></tr>' : 
                              data.map(v => `
                                <tr>
                                    <td><strong>${v.num}</strong></td>
                                    <td>${v.date}</td>
                                    <td>${v.clientName}</td>
                                    <td><small>${v.type}</small></td>
                                    <td>${Number(v.ttc).toLocaleString()}</td>
                                    <td style="color:${v.reste > 0 ? '#dc2626' : '#16a34a'}; font-weight:bold;">${Number(v.reste).toLocaleString()}</td>
                                    <td><span class="status-badge ${v.reste === 0 ? 'status-paid' : 'status-unpaid'}">${v.reste === 0 ? 'Soldé' : 'Impayé'}</span></td>
                                    <td>
                                        <button class="btn" style="padding:5px 10px; font-size:0.75rem;" onclick="showVenteDetails('${v.num}')">Détails</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            lucide.createIcons();
        }

        // --- FONCTIONS VENTES ---
        function openSaleForm(type) {
            document.getElementById('saleModalTitle').textContent = "Édition de " + type;
            document.getElementById('doc-type-label').textContent = type.toLowerCase();
            openModal('saleModal');
        }

        // --- GESTION DES LISTES ARTICLES ---
        function updateSelects() {
            const famSel = document.getElementById('artFamily');
            const subSel = document.getElementById('artSubFamily');
            if(famSel) famSel.innerHTML = families.map(f => `<option value="${f}">${f}</option>`).join('');
            if(subSel) subSel.innerHTML = subfamilies.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function addListOption(selId, inpId, storageKey) {
            const val = document.getElementById(inpId).value.trim();
            if(!val) return;
            if(storageKey === 'families') families.push(val);
            else subfamilies.push(val);
            
            localStorage.setItem(`crm_${storageKey}`, JSON.stringify(storageKey === 'families' ? families : subfamilies));
            document.getElementById(inpId).value = "";
            updateSelects();
            showToast("Liste mise à jour");
        }

        // --- CALCULS ARTICLES ---
        function calculateArticleValues() {
            const price = parseFloat(document.getElementById('artPrice').value) || 0;
            const stock = parseFloat(document.getElementById('artStock').value) || 0;
            
            document.getElementById('artStockVal').value = (price * stock).toLocaleString() + " FCFA";
            document.getElementById('artCostPrice').value = price.toLocaleString() + " FCFA";
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('artPhotoData').value = e.target.result;
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('photoPreview').style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- FORMULAIRE ---
        function openAddForm() {
            document.getElementById('mainForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('modalTitle').textContent = `Nouveau ${currentView.toLowerCase()}`;
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('artPhotoData').value = "";
            
            if(currentView === 'ARTICLE') {
                document.getElementById('fields-entity').style.display = 'none';
                document.getElementById('fields-article').style.display = 'grid';
                updateSelects();
            } else {
                document.getElementById('fields-entity').style.display = 'grid';
                document.getElementById('fields-article').style.display = 'none';
                toggleLimitField();
            }
            openModal('formModal');
        }

        function handleSubmit(e) {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            let payload = {};

            if(currentView === 'ARTICLE') {
                payload = {
                    name: document.getElementById('artName').value.trim(),
                    family: document.getElementById('artFamily').value,
                    subfamily: document.getElementById('artSubFamily').value,
                    price: document.getElementById('artPrice').value,
                    stock: document.getElementById('artStock').value,
                    photo: document.getElementById('artPhotoData').value
                };
                if(!payload.name || !payload.price || !payload.stock) return showToast("Veuillez remplir les champs obligatoires", "#ef4444");
            } else {
                payload = {
                    name: document.getElementById('formName').value.trim(),
                    phone1: document.getElementById('formPhone1').value.trim(),
                    phone2: document.getElementById('formPhone2').value.trim(),
                    address: document.getElementById('formAddress').value.trim(),
                    status: document.getElementById('formStatus').value,
                    limit: document.getElementById('formLimit').value || 0,
                    email: document.getElementById('formEmail').value.trim().toLowerCase()
                };
                if(!payload.name || !payload.phone1 || !payload.address) return showToast("Veuillez remplir les champs obligatoires", "#ef4444");
            }

            const list = db[currentView];
            const isDuplicate = list.some(item => {
                if(editId && item.id === editId) return false;
                if(currentView === 'ARTICLE') return item.name.toLowerCase() === payload.name.toLowerCase();
                return item.name.toLowerCase() === payload.name.toLowerCase() || item.phone1 === payload.phone1;
            });

            if(isDuplicate) return showToast("Erreur: Un enregistrement similaire existe déjà.", "#ef4444");

            if(editId) {
                const idx = list.findIndex(i => i.id === editId);
                list[idx] = { ...list[idx], ...payload };
            } else {
                let prefix = currentView === 'CLIENT' ? 'CL-' : (currentView === 'FOURNISSEUR' ? 'Fr-00' : 'A-00');
                const nextIdNum = list.length > 0 ? Math.max(...list.map(i => parseInt(i.id.replace(prefix, "")))) + 1 : 1;
                const newId = `${prefix}${String(nextIdNum).padStart(currentView === 'CLIENT' ? 3 : 1, '0')}`;
                list.push({ id: newId, ...payload, date: new Date().toISOString().split('T')[0] });
            }

            saveAndRefresh();
            closeModal('formModal');
            showToast("Opération réussie !");
        }

        // --- DETAILS ---
        function showDetails(id) {
            const item = db[currentView].find(i => i.id === id);
            const container = document.getElementById('detailsContainer');
            
            let html = `
                <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                    <h2>Détails ${currentView.toLowerCase()}</h2>
                    <button onclick="closeModal('detailsModal')" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
                </div>
            `;

            if(currentView === 'ARTICLE') {
                html += `
                    <div style="display:flex; gap:20px;">
                        <div style="flex:1; max-width:150px; position:relative;">
                            ${item.photo ? `<img src="${item.photo}" style="width:100%; border-radius:12px;">` : `<div style="width:100%; height:100px; background:#f1f5f9; border-radius:12px; display:flex; align-items:center; justify-content:center;"><i data-lucide="image"></i></div>`}
                            ${item.stock <= 0 ? `<div class="rupture-overlay" style="border-radius:12px;"><span class="rupture-text" style="font-size:0.8rem;">RUPTURE</span></div>` : ''}
                        </div>
                        <div class="card-info" style="font-size:1rem; flex:2;">
                            <p><strong>Code:</strong> ${item.id}</p>
                            <p><strong>Nom:</strong> ${item.name}</p>
                            <p><strong>Famille:</strong> ${item.family} / ${item.subfamily}</p>
                            <p><strong>Prix Initial:</strong> ${Number(item.price).toLocaleString()} FCFA</p>
                            <p><strong>Stock Actuel:</strong> ${Number(item.stock).toLocaleString()}</p>
                            <p><strong>Valeur Stock:</strong> ${(item.price * item.stock).toLocaleString()} FCFA</p>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="card-info" style="font-size:1rem; gap:10px;">
                        <p><strong>Code:</strong> ${item.id}</p>
                        <p><strong>Nom:</strong> ${item.name}</p>
                        <p><strong>Contacts:</strong> ${item.phone1} ${item.phone2 ? '/ '+item.phone2 : ''}</p>
                        <p><strong>Email:</strong> ${item.email || 'N/A'}</p>
                        <p><strong>Adresse:</strong> ${item.address}</p>
                        <p><strong>Statut:</strong> ${item.status}</p>
                    </div>
                `;
            }

            html += `
                <div style="margin-top:2rem; display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn" style="background:#1e293b;" onclick="editItem('${item.id}')"><i data-lucide="edit"></i> Modifier</button>
                    <button class="btn btn-danger" onclick="promptDelete('${item.id}')"><i data-lucide="trash-2"></i> Supprimer</button>
                </div>
            `;
            container.innerHTML = html;
            openModal('detailsModal');
            lucide.createIcons();
        }

        function editItem(id) {
            const item = db[currentView].find(i => i.id === id);
            openAddForm();
            document.getElementById('editId').value = item.id;
            if(currentView === 'ARTICLE') {
                document.getElementById('artName').value = item.name;
                document.getElementById('artFamily').value = item.family;
                document.getElementById('artSubFamily').value = item.subfamily;
                document.getElementById('artPrice').value = item.price;
                document.getElementById('artStock').value = item.stock;
                document.getElementById('artPhotoData').value = item.photo || "";
                if(item.photo) {
                    document.getElementById('previewImg').src = item.photo;
                    document.getElementById('photoPreview').style.display = 'block';
                }
                calculateArticleValues();
            } else {
                document.getElementById('formName').value = item.name;
                document.getElementById('formPhone1').value = item.phone1;
                document.getElementById('formPhone2').value = item.phone2;
                document.getElementById('formAddress').value = item.address;
                document.getElementById('formStatus').value = item.status;
                document.getElementById('formLimit').value = item.limit;
                document.getElementById('formEmail').value = item.email;
                toggleLimitField();
            }
            closeModal('detailsModal');
        }

        // --- SUPPRESSION ---
        function promptDelete(id) {
            deleteTargetId = id;
            document.getElementById('adminCode').value = "";
            openModal('deleteModal');
        }

        function executeDelete() {
            if(document.getElementById('adminCode').value === 'ICONIC') {
                db[currentView] = db[currentView].filter(i => i.id !== deleteTargetId);
                saveAndRefresh();
                closeModal('deleteModal');
                closeModal('detailsModal');
                showToast("Suppression effectuée");
            } else showToast("Code Administrateur Incorrect", "#ef4444");
        }

        // --- UTILITAIRES ---
        function toggleTheme() {
            const b = document.body;
            b.getAttribute('data-theme') === 'dark' ? b.removeAttribute('data-theme') : b.setAttribute('data-theme', 'dark');
            lucide.createIcons();
        }

        function saveAndRefresh() {
            const keys = { CLIENT: 'crm_clients', FOURNISSEUR: 'crm_suppliers', ARTICLE: 'crm_articles', VENTE: 'crm_ventes' };
            localStorage.setItem(keys[currentView], JSON.stringify(db[currentView]));
            render();
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function toggleLimitField() {
            const f = document.getElementById('formLimit');
            const s = document.getElementById('formStatus').value;
            if(f) {
                f.disabled = s !== 'Abonné';
                if(f.disabled) f.value = "";
            }
        }

        function showToast(msg, color = "#10b981") {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.backgroundColor = color;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function filterData() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            render(db[currentView].filter(i => (i.name || i.clientName || '').toLowerCase().includes(q) || i.id.toLowerCase().includes(q)));
        }

        function exportData() {
            const list = db[currentView];
            if(!list.length) return showToast("Rien à exporter", "#ef4444");
            let head, body;
            if(currentView === 'ARTICLE') {
                head = "Code;Nom;Famille;SousFamille;Prix;Stock\n";
                body = list.map(i => `${i.id};${i.name};${i.family};${i.subfamily};${i.price};${i.stock}`).join("\n");
            } else if(currentView === 'VENTE') {
                head = "Num;Date;Client;Type;Total;Reste\n";
                body = list.map(i => `${i.num};${i.date};${i.clientName};${i.type};${i.ttc};${i.reste}`).join("\n");
            } else {
                head = "Code;Nom;Contact;Adresse;Status\n";
                body = list.map(i => `${i.id};${i.name};${i.phone1};${i.address};${i.status}`).join("\n");
            }
            const blob = new Blob([head + body], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Export_${currentView}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        window.onload = () => { render(); lucide.createIcons(); };
    </script>
</body>
</html>