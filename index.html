<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite CRM - Business Management</title>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-global: #ffffff;
            --nav-bg: #1a237e;
            --nav-text: #ffffff;
            --active-bg: #ff4500;
            --active-text: #ffffff;
            --btn-gradient: linear-gradient(135deg, #1e3a8a, #3b82f6);
            --card-bg: #f8fafc;
            --text-main: #1e293b;
            --border-color: #e2e8f0;
            --status-subscriber: #10b981;
            --status-occasional: #ff4500;
            --status-out-of-stock: #f97316;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-global: #0f172a;
            --nav-bg: #020617;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --border-color: #334155;
            --btn-gradient: linear-gradient(135deg, #fb923c, #f97316);
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

        body {
            background-color: var(--bg-global);
            color: var(--text-main);
            transition: var(--transition);
            min-height: 100vh;
        }

        /* --- NAVIGATION --- */
        nav {
            background-color: var(--nav-bg);
            padding: 0 2rem;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .nav-links { display: flex; gap: 10px; height: 100%; align-items: center; }

        .nav-item {
            padding: 10px 20px;
            border-radius: 8px;
            color: var(--nav-text);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            display: flex; align-items: center; gap: 8px; cursor: pointer; opacity: 0.7;
        }

        .nav-item.active { background-color: var(--active-bg); color: var(--active-text); transform: translateY(-2px); opacity: 1; }

        .theme-toggle {
            background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px; border-radius: 50%; cursor: pointer; transition: var(--transition);
        }

        /* --- LAYOUT --- */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }

        .search-wrapper { position: relative; flex: 1; max-width: 400px; }
        .search-wrapper input {
            width: 100%; padding: 12px 20px 12px 45px; border-radius: 30px;
            border: 1px solid var(--border-color); background: var(--card-bg);
            color: var(--text-main); outline: none; transition: var(--transition);
        }
        .search-wrapper input:focus { border-color: var(--active-bg); box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.2); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        .btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
            border-radius: 10px; border: none; color: white; font-weight: 600;
            cursor: pointer; background: var(--btn-gradient); transition: var(--transition);
        }
        .btn:hover { transform: scale(1.03); filter: brightness(1.1); }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; filter: none; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .btn-accent { background: var(--active-bg); }
        
        .btn-edit-yellow {
            background: linear-gradient(135deg, #facc15, #eab308); color: #422006; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* --- GRID & CARDS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .grid-articles { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }

        .card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 1.5rem; transition: var(--transition);
            cursor: pointer; position: relative; display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--active-bg); box-shadow: var(--shadow); }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border-color); color: #64748b; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }

        .article-img-container {
            width: 100%; height: 120px; background: #e2e8f0; border-radius: 12px;
            margin-bottom: 10px; overflow: hidden; display: flex; align-items: center;
            justify-content: center; position: relative;
        }
        .article-img-container img { width: 100%; height: 100%; object-fit: cover; }

        .rupture-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .rupture-text {
            color: #ffffff; font-weight: 900; font-size: 1.2rem; letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); border: 2px solid #ffffff; padding: 4px 12px; transform: rotate(-15deg);
        }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; color: white; }
        .status-subscriber { background-color: var(--status-subscriber); }
        .status-occasional { background-color: var(--status-occasional); }
        .status-rupture { background-color: var(--status-out-of-stock); }

        .card-code { font-size: 0.75rem; color: #64748b; font-weight: 800; }
        .card-name { font-size: 1.1rem; font-weight: 700; margin: 0.5rem 0; }
        .card-info { font-size: 0.85rem; color: #64748b; display: grid; gap: 5px; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--bg-global); width: 95%; max-width: 650px;
            border-radius: 20px; padding: 2rem; max-height: 90vh; overflow-y: auto;
        }
        .modal-lg { max-width: 1000px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .full { grid-column: span 2; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; }
        input, select, textarea {
            width: 100%; padding: 10px; border-radius: 8px;
            border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main);
        }
        input:read-only { background-color: #f1f5f9; cursor: not-allowed; }

        .list-manager { background: #f1f5f9; padding: 10px; border-radius: 8px; margin-top: 5px; display: flex; gap: 5px; }

        /* --- STYLE FACTURE --- */
        .facture-preview {
            background: white; color: black; padding: 40px; border: 1px solid #ddd;
            margin-top: 20px; font-family: 'Segoe UI', sans-serif; line-height: 1.4;
        }
        .facture-header { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .client-info-box { text-align: right; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 300px; }
        .facture-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .facture-table th { background: #f1f5f9; border: 1px solid #ccc; padding: 10px; text-align: center; }
        .facture-table td { border: 1px solid #ccc; padding: 10px; text-align: center; font-size: 0.9rem; }
        .facture-totals { width: 300px; margin-left: auto; margin-top: 20px; }
        .facture-totals div { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }

        .mode-badge { padding: 4px 12px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8rem; display: inline-block; }
        .mode-cash { background-color: #16a34a; }
        .mode-mm { background-color: #2563eb; }
        .mode-credit { background-color: #dc2626; }

        @media print {
            body * { visibility: hidden; }
            .facture-preview, .facture-preview * { visibility: visible; }
            .facture-preview { position: absolute; left: 0; top: 0; width: 100%; border: none; padding: 0; }
            .no-print { display: none !important; }
        }

        #toast {
            position: fixed; bottom: 20px; right: 20px; padding: 12px 24px;
            border-radius: 10px; color: white; transform: translateY(100px);
            transition: 0.3s; z-index: 3000; font-weight: 600;
        }
        #toast.show { transform: translateY(0); }

        .stock-error { border: 2px solid #ef4444 !important; }
        .stock-label-error { color: #ef4444; font-size: 0.7rem; font-weight: bold; }
        .plafond-info { background: #dcfce7; padding: 5px 10px; border-radius: 5px; margin-top: 5px; font-size: 0.8rem; font-weight: bold; color: #166534; }
        .plafond-error { background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: 700; text-align: center; }

        .switch-container { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--active-bg); }
        input:checked + .slider:before { transform: translateX(20px); }

        .details-section { margin-top: 1.5rem; padding: 1rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; }
        .details-title { font-size: 0.85rem; font-weight: bold; color: var(--nav-bg); border-bottom: 2px solid var(--border-color); margin-bottom: 10px; padding-bottom: 5px; text-transform: uppercase; }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem; }
        .details-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dotted var(--border-color); }
        .details-label { color: #64748b; font-weight: 500; }
        .details-value { font-weight: 600; text-align: right; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-links">
            <div class="nav-item active" id="tab-CLIENT" onclick="switchView('CLIENT')">
                <i data-lucide="users"></i> CLIENTS
            </div>
            <div class="nav-item" id="tab-FOURNISSEUR" onclick="switchView('FOURNISSEUR')">
                <i data-lucide="truck"></i> FOURNISSEURS
            </div>
            <div class="nav-item" id="tab-ARTICLE" onclick="switchView('ARTICLE')">
                <i data-lucide="package"></i> ARTICLES
            </div>
            <div class="nav-item" id="tab-VENTE" onclick="switchView('VENTE')">
                <i data-lucide="shopping-cart"></i> VENTES
            </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">
            <i data-lucide="moon"></i>
        </button>
    </nav>

    <div class="container">
        <div class="action-bar" id="action-bar-container">
            <div class="search-wrapper">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" id="searchInput" placeholder="Rechercher..." oninput="filterData()">
            </div>
            <div id="dynamic-buttons" style="display: flex; gap: 10px;">
                <button class="btn" onclick="exportData()">
                    <i data-lucide="download"></i> Exporter CSV
                </button>
                <button class="btn" onclick="openAddForm()">
                    <i data-lucide="plus-circle"></i> Nouveau <span id="btn-label">Client</span>
                </button>
            </div>
        </div>

        <div id="mainContent">
            <div class="grid" id="mainGrid"></div>
        </div>
    </div>

    <!-- Modal Formulaire Standard -->
    <div class="modal-overlay" id="formModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                <h2 id="modalTitle">Nouveau</h2>
                <button onclick="closeModal('formModal')" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            <form id="mainForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div id="fields-entity" class="form-grid">
                    <div class="form-group full">
                        <label id="formNameLabel">Nom Complet / Raison Sociale *</label>
                        <input type="text" id="formName">
                    </div>
                    <div id="extra-article-fields" class="form-grid full" style="display:none; gap: 1rem; margin-top: 1rem;">
                        <div class="form-group">
                            <label>Famille *</label>
                            <select id="artFamily"></select>
                            <div class="list-manager">
                                <input type="text" id="newFamily" placeholder="Nouvelle famille">
                                <button type="button" onclick="addListOption('artFamily', 'newFamily', 'families')" class="btn" style="padding:5px 10px;"><i data-lucide="plus"></i></button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Sous-Famille *</label>
                            <select id="artSubFamily"></select>
                            <div class="list-manager">
                                <input type="text" id="newSubFamily" placeholder="Nouvelle sous-famille">
                                <button type="button" onclick="addListOption('artSubFamily', 'newSubFamily', 'subfamilies')" class="btn" style="padding:5px 10px;"><i data-lucide="plus"></i></button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Prix Initial *</label>
                            <input type="number" id="artPrice" min="0" oninput="calculateArticleValues()">
                        </div>
                        <div class="form-group">
                            <label>Stock Initial *</label>
                            <input type="number" id="artStock" min="0" oninput="calculateArticleValues()">
                        </div>
                        <div class="form-group">
                            <label>Valeur Stock Initial (Auto)</label>
                            <input type="text" id="artStockVal" readonly>
                        </div>
                        <div class="form-group">
                            <label>Prix de Revient (Auto)</label>
                            <input type="text" id="artCostPrice" readonly>
                        </div>
                        <div class="form-group full">
                            <label>Photo d'illustration</label>
                            <input type="file" id="artPhoto" accept="image/*" onchange="handleImageUpload(this)">
                            <input type="hidden" id="artPhotoData">
                            <div id="photoPreview" style="margin-top:10px; height:100px; display:none;">
                                <img src="" id="previewImg" style="height:100%; border-radius:8px;">
                            </div>
                        </div>
                    </div>
                    <div id="tiers-only-fields" class="form-grid full" style="gap: 1rem;">
                        <div class="form-group">
                            <label>Contact Principal *</label>
                            <input type="tel" id="formPhone1">
                        </div>
                        <div class="form-group">
                            <label>Contact Secondaire</label>
                            <input type="tel" id="formPhone2">
                        </div>
                        <div class="form-group full">
                            <label>Adresse Géographique *</label>
                            <input type="text" id="formAddress">
                        </div>
                        <div class="form-group">
                            <label>Statut *</label>
                            <select id="formStatus" onchange="toggleLimitField()">
                                <option value="Occasionnel">Occasionnel</option>
                                <option value="Abonné">Abonné</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Plafond Financier (FCFA) *</label>
                            <input type="number" id="formLimit">
                        </div>
                        <div class="form-group full">
                            <label>Adresse Mail</label>
                            <input type="email" id="formEmail">
                        </div>
                    </div>
                </div>
                <div style="margin-top:2rem; display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" class="btn" style="background:#94a3b8;" onclick="closeModal('formModal')">Annuler</button>
                    <button type="submit" class="btn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Facture Dynamique -->
    <div class="modal-overlay" id="saleModal">
        <div class="modal-content modal-lg">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;" class="no-print">
                <h2 id="saleModalTitle">Édition de Document</h2>
                <button onclick="closeModal('saleModal')" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            
            <div class="form-grid no-print" style="margin-bottom: 20px;">
                <input type="hidden" id="editVenteId">
                <div class="form-group full">
                    <label>Sélectionner le Client *</label>
                    <select id="saleClientSelect" onchange="checkCreditAvailability()"></select>
                    <div id="plafondRemainingInfo" class="plafond-info" style="display:none;"></div>
                </div>
                <div class="form-group">
                    <label>Mode de Règlement *</label>
                    <select id="salePaymentMode" onchange="checkCreditAvailability()">
                        <option value="Cash">Cash</option>
                        <option value="Mobile Money">Mobile Money</option>
                        <option value="Crédit">Crédit</option>
                    </select>
                    <div id="creditAlert" class="plafond-error" style="display:none;">
                        <i data-lucide="alert-triangle" style="display:inline-block; vertical-align:middle; margin-right:5px;"></i>
                        <span id="creditAlertText">COMMANDE IMPOSSIBLE : PLAFOND FINANCIER DÉPASSÉ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Date de livraison souhaitée</label>
                    <input type="date" id="saleDate">
                </div>
                <div class="form-group full">
                    <div class="switch-container">
                        <label class="switch">
                            <input type="checkbox" id="tvaToggle" onchange="updateFacture()">
                            <span class="slider"></span>
                        </label>
                        <span style="font-size: 0.85rem; font-weight: 600;">Appliquer la TVA (18%)</span>
                    </div>
                </div>
                <div id="adminCodeSection" class="form-group full" style="display:none; margin-top:10px; padding:10px; background:#fff7ed; border-radius:10px;">
                    <label style="color:#c2410c;">Code Administrateur requis pour valider les modifications *</label>
                    <input type="password" id="adminCodeInput" placeholder="Entrez le code">
                </div>
            </div>

            <div id="saleItemsContainer" class="no-print" style="margin-bottom: 30px;">
                <label style="margin-bottom: 10px; display: block; font-weight: bold;">Articles (5 maximum)</label>
                <div id="saleLines"></div>
            </div>

            <!-- Preview Facture -->
            <div id="facturePreview" class="facture-preview">
                <div class="facture-header">
                    <div class="company-info">
                        <h2 style="color: var(--nav-bg); font-size: 2rem; margin-bottom: 5px;">Ayden</h2>
                        <p>+225 0759803724 et +225 0576233780</p>
                        <p>ayden@corporate.com</p>
                        <p>Akoupé, Quartier Résidentiel</p>
                        <p style="font-style: italic; margin-top: 5px; color: #666;">La santé à la portée de tous !</p>
                    </div>
                    <div class="client-info-box" id="factureClientDisplay">
                        <em>Sélectionnez un client...</em>
                    </div>
                </div>
                <div style="margin: 20px 0;">
                    <h3 style="text-decoration: underline; margin-bottom: 5px;">FACTURE N° <span id="factureNumber">---</span></h3>
                    <p><strong>Mode de règlement :</strong> <span id="factureModeDisplay">---</span></p>
                    <p><strong>Date de livraison souhaitée :</strong> <span id="factureDateDisplay">---</span></p>
                </div>
                <table class="facture-table">
                    <thead>
                        <tr>
                            <th>Ordre</th>
                            <th>Code</th>
                            <th>Désignation</th>
                            <th>Qté</th>
                            <th>P.U (FCFA)</th>
                            <th>Remise (%)</th>
                            <th>Valeur (FCFA)</th>
                        </tr>
                    </thead>
                    <tbody id="factureTableBody"></tbody>
                </table>
                <div class="facture-totals" id="factureTotalsDisplay"></div>
                <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
                    <p id="factureInWords" style="font-weight: bold; margin-bottom: 15px;"></p>
                    <p>Vous disposez d’une franchise de 30 jours pour régler cette aventure.</p>
                    <p style="margin-top: 15px; font-weight: 600;">Merci pour la confiance et à très bientôt !</p>
                </div>
            </div>
            <div style="margin-top:2rem; display:flex; justify-content:flex-end; gap:10px;" class="no-print">
                <button type="button" class="btn" style="background:#94a3b8;" onclick="closeModal('saleModal')">Annuler</button>
                <button type="button" class="btn" id="btnSavePrint" style="background-color: #ff4500;" onclick="saveAndPrint()">Enregistrer et Imprimer</button>
            </div>
        </div>
    </div>

    <!-- Modal Règlement -->
    <div class="modal-overlay" id="payModal">
        <div class="modal-content" style="max-width:400px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                <h2>Nouveau Règlement</h2>
                <button onclick="closeModal('payModal')" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>N° Règlement (Auto)</label>
                    <input type="text" id="payNum" readonly>
                </div>
                <div class="form-group">
                    <label>Reste à payer (FCFA)</label>
                    <input type="text" id="payReste" readonly>
                </div>
                <div class="form-group">
                    <label>Mode de Règlement *</label>
                    <select id="payMode">
                        <option value="Cash">Cash</option>
                        <option value="Mobile Money">Mobile Money</option>
                        <option value="Chèque">Chèque</option>
                        <option value="Virement">Virement</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Montant du versement *</label>
                    <input type="number" id="payAmount" min="1">
                </div>
                <div class="form-group">
                    <label>Référence / Preuve *</label>
                    <input type="text" id="payProof" placeholder="EX: REF-MM-12345">
                </div>
                <div style="margin-top:1rem;">
                    <button class="btn full" style="width:100%; justify-content:center;" onclick="executePayment()">Valider le paiement</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Détails Vente -->
    <div class="modal-overlay" id="venteDetailsModal">
        <div class="modal-content modal-lg" id="venteDetailsContent"></div>
    </div>

    <div id="toast"></div>

    <script>
        // --- CONFIG ---
        const ADMIN_CODE = "ICONIC";

        // --- ETAT GLOBAL ---
        let currentView = 'CLIENT';
        let families = JSON.parse(localStorage.getItem('crm_families')) || ["Electronique", "Bureau", "Divers"];
        let subfamilies = JSON.parse(localStorage.getItem('crm_subfamilies')) || ["Informatique", "Papeterie", "Autre"];
        
        let db = {
            CLIENT: JSON.parse(localStorage.getItem('crm_clients')) || [],
            FOURNISSEUR: JSON.parse(localStorage.getItem('crm_suppliers')) || [],
            ARTICLE: JSON.parse(localStorage.getItem('crm_articles')) || [],
            VENTE: JSON.parse(localStorage.getItem('crm_ventes')) || []
        };
        let currentPayingVente = null;
        let globalStockValid = true;
        let globalPlafondValid = true;

        // --- NAVIGATION ---
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`tab-${view}`).classList.add('active');
            const btnLabel = document.getElementById('btn-label');
            const grid = document.getElementById('mainGrid');
            const dynamicButtons = document.getElementById('dynamic-buttons');
            
            if (view === 'VENTE') {
                dynamicButtons.innerHTML = `<button class="btn" onclick="openSaleForm()"><i data-lucide="receipt"></i> FACTURE</button>`;
            } else {
                if(btnLabel) btnLabel.textContent = view.toLowerCase();
                dynamicButtons.innerHTML = `
                    <button class="btn" onclick="exportData()"><i data-lucide="download"></i> Exporter CSV</button>
                    <button class="btn" onclick="openAddForm()"><i data-lucide="plus-circle"></i> Nouveau <span id="btn-label">${view.toLowerCase()}</span></button>
                `;
            }
            if(view === 'ARTICLE') grid.classList.add('grid-articles'); else grid.classList.remove('grid-articles');
            render();
        }

        // --- RENDER ---
        function render(data = db[currentView]) {
            const grid = document.getElementById('mainGrid');
            if (currentView === 'VENTE') { renderVentes(grid, data); return; }
            if (data.length === 0) {
                grid.innerHTML = `<div class="full" style="text-align:center; padding:4rem; opacity:0.5; grid-column: 1 / -1;">Aucun enregistrement dans ${currentView}.</div>`;
                return;
            }
            if (currentView === 'ARTICLE') {
                grid.innerHTML = data.map(item => `
                    <div class="card" onclick="editItem('${item.id}')">
                        <div class="article-img-container">
                            ${item.photo ? `<img src="${item.photo}">` : `<i data-lucide="image" style="color:#94a3b8"></i>`}
                            ${item.stock <= 0 ? `<div class="rupture-overlay"><span class="rupture-text">RUPTURE</span></div>` : ''}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="card-code">${item.id}</span>
                            ${item.stock <= 0 ? `<span class="status-badge status-rupture">RUPTURE</span>` : ''}
                        </div>
                        <h3 class="card-name">${item.name}</h3>
                        <div class="card-info">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="color: #f97316; font-weight: 600;">${Number(item.stock).toLocaleString()} en stock</span>
                                <span style="color: var(--text-main); font-weight: 800;">${Number(item.price).toLocaleString()} FCFA</span>
                            </div>
                            <span style="font-size:0.75rem; color:#94a3b8;">${item.family} / ${item.subfamily}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                // Rendu Client ET Fournisseur (activé)
                grid.innerHTML = data.map(item => `
                    <div class="card" onclick="editItem('${item.id}')">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="card-code">${item.id}</span>
                            <span class="status-badge ${item.status === 'Abonné' ? 'status-subscriber' : 'status-occasional'}">${item.status}</span>
                        </div>
                        <h3 class="card-name">${item.name}</h3>
                        <div class="card-info">
                            <span><i data-lucide="phone" size="14"></i> ${item.phone1}</span>
                            <span><i data-lucide="map-pin" size="14"></i> ${item.address}</span>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function renderVentes(container, data) {
            container.innerHTML = `
                <div class="card full" style="padding: 0; overflow-x: auto; grid-column: 1 / -1;">
                    <table>
                        <thead>
                            <tr>
                                <th>N°</th>
                                <th>Livraison souhaitée</th>
                                <th>Client</th>
                                <th>Total TTC</th>
                                <th>Reste</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.length === 0 ? '<tr><td colspan="7" style="text-align:center; padding:2rem; opacity:0.5;">Aucune vente enregistrée.</td></tr>' : 
                              data.map(v => `
                                <tr>
                                    <td><strong>${v.num}</strong></td>
                                    <td>${v.date}</td>
                                    <td>${v.clientName}</td>
                                    <td>${Math.round(v.ttc).toLocaleString()}</td>
                                    <td style="color:${v.reste > 0 ? '#dc2626' : '#16a34a'}; font-weight:bold;">${Math.round(v.reste).toLocaleString()}</td>
                                    <td>
                                        <span class="status-badge" style="background-color:${v.reste <= 0 ? '#dcfce7' : '#fee2e2'}; color:${v.reste <= 0 ? '#16a34a' : '#dc2626'}">
                                            ${v.reste <= 0 ? 'Soldé' : 'Impayé'}
                                        </span>
                                    </td>
                                    <td style="display:flex; gap:5px;">
                                        <button class="btn" style="padding:5px 10px; font-size:0.75rem; background: #334155;" onclick="showVenteDetails('${v.id}')">Détails</button>
                                        <button class="btn btn-edit-yellow" style="padding:5px 10px; font-size:0.75rem;" onclick="editSale('${v.id}')">
                                            <i data-lucide="edit-3" size="14"></i> Modifier
                                        </button>
                                        ${v.reste > 0 ? `<button class="btn btn-accent" style="padding:5px 10px; font-size:0.75rem;" onclick="openPayModal('${v.id}')">Régler</button>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            lucide.createIcons();
        }

        // --- FONCTIONS VENTES ---
        function openSaleForm() {
            if(db.ARTICLE.length === 0) return showToast("Veuillez créer des articles d'abord", "#ef4444");
            document.getElementById('editVenteId').value = "";
            document.getElementById('adminCodeSection').style.display = 'none';
            document.getElementById('adminCodeInput').value = "";
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            const factNum = 'F-' + (db.VENTE.length + 1001);
            document.getElementById('factureNumber').textContent = factNum;
            document.getElementById('tvaToggle').checked = false;
            
            // Sélection des clients UNIQUEMENT pour la facturation
            const clientSel = document.getElementById('saleClientSelect');
            clientSel.innerHTML = '<option value="">-- Sélectionner un client --</option>' + 
                db.CLIENT.map(c => `<option value="${c.id}">${c.name} (${c.id})</option>`).join('');
            
            const linesContainer = document.getElementById('saleLines');
            linesContainer.innerHTML = '';
            for(let i=1; i<=5; i++) {
                linesContainer.innerHTML += `
                    <div class="form-grid" style="margin-bottom:10px; background:#f8fafc; padding:10px; border-radius:10px; border:1px solid #e2e8f0;">
                        <select id="lineArt_${i}" onchange="updateFacture()">
                            <option value="">-- Article ${i} --</option>
                            ${db.ARTICLE.map(a => `<option value="${a.id}">${a.name} (Stock: ${a.stock})</option>`).join('')}
                        </select>
                        <div style="display:flex; gap:5px; flex-direction:column;">
                            <div style="display:flex; gap:5px;">
                                <input type="number" id="lineQty_${i}" placeholder="Qté" oninput="updateFacture()" min="1">
                                <input type="number" id="lineRem_${i}" placeholder="Remise %" oninput="updateFacture()" min="0" max="100">
                            </div>
                            <span id="stockWarning_${i}" class="stock-label-error" style="display:none;">Indisponible</span>
                        </div>
                    </div>
                `;
            }
            document.getElementById('plafondRemainingInfo').style.display = 'none';
            document.getElementById('creditAlert').style.display = 'none';
            updateFacture();
            openModal('saleModal');
        }

        function editSale(id) {
            const v = db.VENTE.find(x => x.id === id);
            v.items.forEach(soldItem => {
                const article = db.ARTICLE.find(a => a.id === soldItem.id);
                if (article) article.stock += soldItem.qty;
            });
            saveData();
            openSaleForm();
            document.getElementById('editVenteId').value = v.id;
            document.getElementById('factureNumber').textContent = v.num;
            document.getElementById('saleClientSelect').value = v.clientId;
            document.getElementById('salePaymentMode').value = v.mode;
            document.getElementById('saleDate').value = v.date;
            document.getElementById('tvaToggle').checked = v.tvaEnabled;
            document.getElementById('adminCodeSection').style.display = 'block';
            v.items.forEach((item, index) => {
                const i = index + 1;
                document.getElementById(`lineArt_${i}`).value = item.id;
                document.getElementById(`lineQty_${i}`).value = item.qty;
                document.getElementById(`lineRem_${i}`).value = item.rem;
            });
            checkCreditAvailability();
            updateFacture();
            render();
        }

        function checkCreditAvailability() {
            const cid = document.getElementById('saleClientSelect').value;
            const mode = document.getElementById('salePaymentMode').value;
            const alertBox = document.getElementById('creditAlert');
            const alertText = document.getElementById('creditAlertText');
            const plafondInfo = document.getElementById('plafondRemainingInfo');
            if (!cid) {
                plafondInfo.style.display = 'none'; alertBox.style.display = 'none';
                globalPlafondValid = true; updateFacture(); return;
            }
            const tiers = db.CLIENT.find(c => c.id === cid);
            if (!tiers) return;

            if (mode === 'Crédit' && tiers.status === 'Occasionnel') {
                alertBox.style.display = 'block'; alertText.textContent = "PRESTATION À CRÉDIT INTERDITE POUR LES CLIENTS OCCASIONNELS";
                globalPlafondValid = false; updateFacture(); return;
            }
            const totalImpayes = db.VENTE.filter(v => v.clientId === cid).reduce((sum, v) => sum + v.reste, 0);
            const ttcEncours = calculateTTC();
            const plafondTotal = parseFloat(tiers.limit) || 0;
            const restePlafond = Math.max(0, plafondTotal - totalImpayes);
            plafondInfo.innerHTML = `Plafond restant : ${Math.round(restePlafond).toLocaleString()} FCFA / ${Math.round(plafondTotal).toLocaleString()} FCFA`;
            plafondInfo.style.display = 'block';
            if (mode === 'Crédit' && (totalImpayes + ttcEncours) > plafondTotal) {
                alertBox.style.display = 'block'; alertText.textContent = "COMMANDE IMPOSSIBLE : PLAFOND FINANCIER DÉPASSÉ";
                globalPlafondValid = false;
            } else { alertBox.style.display = 'none'; globalPlafondValid = true; }
            updateFacture();
        }

        function calculateTTC() {
            let totalNetHT = 0;
            const useTVA = document.getElementById('tvaToggle').checked;
            for(let i=1; i<=5; i++) {
                const aid = document.getElementById(`lineArt_${i}`).value;
                const qty = parseFloat(document.getElementById(`lineQty_${i}`).value) || 0;
                const rem = parseFloat(document.getElementById(`lineRem_${i}`).value) || 0;
                if(aid && qty > 0) {
                    const art = db.ARTICLE.find(a => a.id === aid);
                    totalNetHT += (art.price * qty) * (1 - rem/100);
                }
            }
            return Math.round(totalNetHT * (useTVA ? 1.18 : 1.0));
        }

        function updateFacture() {
            const cid = document.getElementById('saleClientSelect').value;
            const mode = document.getElementById('salePaymentMode').value;
            const sDate = document.getElementById('saleDate').value;
            const useTVA = document.getElementById('tvaToggle').checked;
            const clientBox = document.getElementById('factureClientDisplay');
            const tbody = document.getElementById('factureTableBody');
            const totalsBox = document.getElementById('factureTotalsDisplay');
            const btnSave = document.getElementById('btnSavePrint');
            const modeDisplay = document.getElementById('factureModeDisplay');
            const dateDisplay = document.getElementById('factureDateDisplay');
            dateDisplay.textContent = sDate || '---';
            if (cid) {
                const c = db.CLIENT.find(x => x.id === cid);
                clientBox.innerHTML = `
                    <h4 style="margin-bottom:5px;">DESTINATAIRE :</h4>
                    <p><strong>${c.name}</strong></p>
                    <p>${c.phone1} / ${c.phone2 || ''}</p>
                    <p>${c.email || ''}</p>
                    <p>${c.address}</p>
                    <p>Statut : <strong>${c.status || 'N/A'}</strong></p>
                `;
            } else clientBox.innerHTML = '<em>Sélectionnez un client...</em>';
            let badgeClass = 'mode-badge ';
            if(mode === 'Cash') badgeClass += 'mode-cash';
            else if(mode === 'Mobile Money') badgeClass += 'mode-mm';
            else badgeClass += 'mode-credit';
            modeDisplay.innerHTML = `<span class="${badgeClass}">${mode}</span>`;
            tbody.innerHTML = '';
            let totalBrut = 0; let totalRemise = 0; let count = 0; globalStockValid = true;
            for(let i=1; i<=5; i++) {
                const aid = document.getElementById(`lineArt_${i}`).value;
                const qtyInput = document.getElementById(`lineQty_${i}`);
                const warning = document.getElementById(`stockWarning_${i}`);
                const qty = parseFloat(qtyInput.value) || 0;
                const rem = parseFloat(document.getElementById(`lineRem_${i}`).value) || 0;
                if(aid) {
                    const art = db.ARTICLE.find(a => a.id === aid);
                    if(qty > art.stock) {
                        qtyInput.classList.add('stock-error'); warning.style.display = 'block';
                        warning.textContent = `Stock insuffisant (${art.stock} max)`; globalStockValid = false;
                    } else { qtyInput.classList.remove('stock-error'); warning.style.display = 'none'; }
                    if(qty > 0) {
                        count++; const valBrut = art.price * qty; const valRem = valBrut * (rem/100);
                        const valNet = valBrut - valRem; totalBrut += valBrut; totalRemise += valRem;
                        tbody.innerHTML += `<tr><td>${count}</td><td>${art.id}</td><td>${art.name}</td><td>${qty}</td><td>${Math.round(art.price).toLocaleString()}</td><td>${rem}%</td><td>${Math.round(valNet).toLocaleString()}</td></tr>`;
                    }
                } else { qtyInput.classList.remove('stock-error'); warning.style.display = 'none'; }
            }
            btnSave.disabled = (!globalStockValid || !globalPlafondValid || !cid || count === 0);
            const netHT = totalBrut - totalRemise;
            const tva = useTVA ? (netHT * 0.18) : 0;
            const ttc = Math.round(netHT + tva);
            totalsBox.innerHTML = `
                <div><span>Total Brut HT:</span> <span>${Math.round(totalBrut).toLocaleString()} FCFA</span></div>
                <div><span>Montant Remise:</span> <span>${Math.round(totalRemise).toLocaleString()} FCFA</span></div>
                <div><span>Somme HT:</span> <span>${Math.round(netHT).toLocaleString()} FCFA</span></div>
                <div><span>Montant TVA (${useTVA ? '18%' : 'Exonéré'}):</span> <span>${Math.round(tva).toLocaleString()} FCFA</span></div>
                <div style="font-weight:bold; font-size:1.1rem; border-top:2px solid #000; margin-top:5px;"><span>TOTAL TTC:</span> <span>${ttc.toLocaleString()} FCFA</span></div>
            `;
            document.getElementById('factureInWords').textContent = `Votre facture est de ${ttc.toLocaleString()} Francs CFA.`;
        }

        function saveAndPrint() {
            const editId = document.getElementById('editVenteId').value;
            if (editId) {
                const code = document.getElementById('adminCodeInput').value;
                if (code !== ADMIN_CODE) return showToast("Code administrateur incorrect", "#ef4444");
            }
            if(!globalStockValid) return showToast("Certains articles dépassent le stock disponible", "#ef4444");
            if(!globalPlafondValid) return showToast("Action bloquée : Vérifiez les plafonds ou le statut client", "#ef4444");
            const cid = document.getElementById('saleClientSelect').value;
            const factNum = document.getElementById('factureNumber').textContent;
            const useTVA = document.getElementById('tvaToggle').checked;
            const items = [];
            let totalBrut = 0; let totalRemise = 0;
            for(let i=1; i<=5; i++) {
                const aid = document.getElementById(`lineArt_${i}`).value;
                const qty = parseFloat(document.getElementById(`lineQty_${i}`).value) || 0;
                const rem = parseFloat(document.getElementById(`lineRem_${i}`).value) || 0;
                if(aid && qty > 0) {
                    const art = db.ARTICLE.find(a => a.id === aid);
                    totalBrut += art.price * qty; totalRemise += (art.price * qty) * (rem/100);
                    items.push({ id: aid, name: art.name, qty: qty, price: art.price, rem: rem });
                    art.stock -= qty;
                }
            }
            if(!cid || items.length === 0) return showToast("Données incomplètes", "#ef4444");
            const netHT = totalBrut - totalRemise;
            const tva = useTVA ? (netHT * 0.18) : 0;
            const ttc = Math.round(netHT + tva);
            const tiers = db.CLIENT.find(c => c.id === cid);
            const saleData = {
                num: factNum, creationDate: new Date().toLocaleDateString('fr-FR'),
                date: document.getElementById('saleDate').value, clientId: cid,
                clientName: tiers.name, clientStatus: tiers.status,
                brutHT: totalBrut, remiseTotal: totalRemise, netHT: netHT,
                tvaAmount: tva, ttc: ttc, reste: ttc,
                mode: document.getElementById('salePaymentMode').value,
                tvaEnabled: useTVA, items: items,
                payments: editId ? db.VENTE.find(v => v.id === editId).payments : []
            };
            const totalPaid = saleData.payments.reduce((s, p) => s + p.amount, 0);
            saleData.reste = Math.max(0, ttc - totalPaid);
            if (editId) {
                const idx = db.VENTE.findIndex(v => v.id === editId);
                db.VENTE[idx] = { ...db.VENTE[idx], ...saleData };
            } else db.VENTE.push({ id: 'VTE-' + Date.now(), ...saleData });
            saveData();
            const originalTitle = document.title; document.title = factNum; window.print(); document.title = originalTitle;
            closeModal('saleModal'); switchView('VENTE'); showToast(editId ? "Vente modifiée" : "Vente enregistrée");
        }

        // --- GESTION REGLEMENTS ---
        function getNextReglementNumber() {
            let total = 0;
            db.VENTE.forEach(v => { total += (v.payments ? v.payments.length : 0); });
            return 'R-' + String(total + 1).padStart(4, '0');
        }

        function openPayModal(id) {
            currentPayingVente = db.VENTE.find(v => v.id === id);
            document.getElementById('payNum').value = getNextReglementNumber();
            document.getElementById('payReste').value = Math.round(currentPayingVente.reste).toLocaleString();
            document.getElementById('payAmount').value = Math.round(currentPayingVente.reste);
            document.getElementById('payProof').value = "";
            openModal('payModal');
        }

        function executePayment() {
            const amount = Math.round(parseFloat(document.getElementById('payAmount').value));
            const proof = document.getElementById('payProof').value.trim();
            const mode = document.getElementById('payMode').value;
            const numReg = document.getElementById('payNum').value;

            if(!amount || amount <= 0 || !proof) return showToast("Champs obligatoires manquants", "#ef4444");
            if(amount > currentPayingVente.reste) return showToast("Montant excessif", "#ef4444");

            if (!currentPayingVente.payments) currentPayingVente.payments = [];
            
            currentPayingVente.reste -= amount;
            currentPayingVente.payments.push({
                num: numReg,
                date: new Date().toLocaleDateString('fr-FR'),
                amount: amount,
                mode: mode,
                proof: proof
            });

            saveData();
            closeModal('payModal');
            render();
            showToast("Paiement validé");
        }

        function showVenteDetails(id) {
            const v = db.VENTE.find(x => x.id === id);
            const content = document.getElementById('venteDetailsContent');
            const totalPaye = (v.payments || []).reduce((s, p) => s + p.amount, 0);
            const dateLivraisonFinale = v.reste <= 0 ? (v.payments && v.payments.length ? v.payments[v.payments.length - 1].date : 'N/A') : 'En attente';
            let badgeClass = 'mode-badge ';
            if(v.mode === 'Cash') badgeClass += 'mode-cash'; else if(v.mode === 'Mobile Money') badgeClass += 'mode-mm'; else badgeClass += 'mode-credit';

            content.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                    <div>
                        <h2 style="color:var(--nav-bg)">DÉTAILS DE L'OPÉRATION</h2>
                        <p style="font-size:0.9rem; color:#64748b;">Consultation de la fiche de vente</p>
                    </div>
                    <button onclick="closeModal('venteDetailsModal')" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
                </div>
                <div class="form-grid">
                    <div class="details-section" style="margin-top:0;">
                        <div class="details-title">Information Document</div>
                        <div class="details-item"><span class="details-label">N° Facture</span><span class="details-value">${v.num}</span></div>
                        <div class="details-item"><span class="details-label">Date Commande</span><span class="details-value">${v.creationDate || v.date}</span></div>
                        <div class="details-item"><span class="details-label">Date Livraison Souhaitée</span><span class="details-value">${v.date}</span></div>
                        <div class="details-item"><span class="details-label">Date de Livraison Effective</span><span class="details-value" style="color:${v.reste <= 0 ? '#16a34a' : '#f97316'}">${dateLivraisonFinale}</span></div>
                        <div class="details-item"><span class="details-label">Mode de Règlement Global</span><span class="details-value"><span class="${badgeClass}">${v.mode}</span></span></div>
                    </div>
                    <div class="details-section" style="margin-top:0;">
                        <div class="details-title">Information Tiers</div>
                        <div class="details-item"><span class="details-label">Client</span><span class="details-value">${v.clientName}</span></div>
                        <div class="details-item"><span class="details-label">Statut Client</span><span class="details-value"><span class="status-badge ${v.clientStatus === 'Abonné' ? 'status-subscriber' : 'status-occasional'}" style="font-size:0.6rem;">${v.clientStatus || 'N/A'}</span></span></div>
                    </div>
                    <div class="details-section full">
                        <div class="details-title">Récapitulatif Financier</div>
                        <div class="details-grid">
                            <div>
                                <div class="details-item"><span class="details-label">Total HT Brut</span><span class="details-value">${Math.round(v.brutHT || v.ttc).toLocaleString()} FCFA</span></div>
                                <div class="details-item"><span class="details-label">Remise Totale</span><span class="details-value" style="color:#dc2626">-${Math.round(v.remiseTotal || 0).toLocaleString()} FCFA</span></div>
                                <div class="details-item"><span class="details-label">Montant Net HT</span><span class="details-value">${Math.round(v.netHT || v.ttc).toLocaleString()} FCFA</span></div>
                                <div class="details-item"><span class="details-label">TVA (18%)</span><span class="details-value">${Math.round(v.tvaAmount || 0).toLocaleString()} FCFA</span></div>
                            </div>
                            <div style="background:#f1f5f9; padding:10px; border-radius:8px;">
                                <div class="details-item"><span class="details-label" style="font-weight:bold; color:#1e293b">MONTANT TTC</span><span class="details-value" style="font-size:1.1rem; color:var(--nav-bg)">${Math.round(v.ttc).toLocaleString()} FCFA</span></div>
                                <div class="details-item"><span class="details-label">Montant Déjà Payé</span><span class="details-value" style="color:#16a34a">${Math.round(totalPaye).toLocaleString()} FCFA</span></div>
                                <div class="details-item" style="border-top:1px solid #cbd5e1; margin-top:5px; padding-top:5px;"><span class="details-label" style="font-weight:bold; color:#dc2626">RESTE À PAYER</span><span class="details-value" style="font-size:1.1rem; color:#dc2626">${Math.round(v.reste).toLocaleString()} FCFA</span></div>
                                <div class="details-item"><span class="details-label">Nombre de Règlements</span><span class="details-value">${v.payments ? v.payments.length : 0} versement(s)</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="details-section">
                    <div class="details-title">Articles et Quantités Commandées</div>
                    <table style="margin-top:10px;">
                        <thead><tr><th>Désignation</th><th style="text-align:center">Qté</th><th style="text-align:right">P.U</th><th style="text-align:right">Remise</th><th style="text-align:right">Total Ligne</th></tr></thead>
                        <tbody>${v.items.map(i => `<tr><td>${i.name}</td><td style="text-align:center"><strong>${i.qty}</strong></td><td style="text-align:right">${Math.round(i.price).toLocaleString()}</td><td style="text-align:right">${i.rem}%</td><td style="text-align:right; font-weight:600;">${Math.round(i.qty * i.price * (1-i.rem/100)).toLocaleString()} FCFA</td></tr>`).join('')}</tbody>
                    </table>
                </div>
                <div class="details-section">
                    <div class="details-title">Historique des Règlements</div>
                    <table style="margin-top:10px;">
                        <thead><tr><th>N° Règl.</th><th>Date</th><th>Mode</th><th>Montant Versé</th><th>Preuve</th></tr></thead>
                        <tbody>${v.payments && v.payments.length ? v.payments.map(p => `<tr><td><strong>${p.num || '---'}</strong></td><td>${p.date}</td><td>${p.mode || '---'}</td><td style="font-weight:600; color:#16a34a">${Math.round(p.amount).toLocaleString()} FCFA</td><td>${p.proof}</td></tr>`).join('') : '<tr><td colspan="5" style="text-align:center; padding:10px; opacity:0.5;">Aucun règlement effectué pour le moment.</td></tr>'}</tbody>
                    </table>
                </div>
            `;
            openModal('venteDetailsModal'); lucide.createIcons();
        }

        // --- GESTION ADMINISTRATIVE ---
        function updateSelects() {
            const famSel = document.getElementById('artFamily'); const subSel = document.getElementById('artSubFamily');
            if(famSel) famSel.innerHTML = families.map(f => `<option value="${f}">${f}</option>`).join('');
            if(subSel) subSel.innerHTML = subfamilies.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function addListOption(selId, inpId, storageKey) {
            const val = document.getElementById(inpId).value.trim(); if(!val) return;
            if(storageKey === 'families') families.push(val); else subfamilies.push(val);
            localStorage.setItem(`crm_${storageKey}`, JSON.stringify(storageKey === 'families' ? families : subfamilies));
            document.getElementById(inpId).value = ""; updateSelects(); showToast("Liste mise à jour");
        }

        function calculateArticleValues() {
            const price = parseFloat(document.getElementById('artPrice').value) || 0;
            const stock = parseFloat(document.getElementById('artStock').value) || 0;
            document.getElementById('artStockVal').value = Math.round(price * stock).toLocaleString() + " FCFA";
            document.getElementById('artCostPrice').value = Math.round(price).toLocaleString() + " FCFA";
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('artPhotoData').value = e.target.result;
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('photoPreview').style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function openAddForm() {
            document.getElementById('mainForm').reset(); document.getElementById('editId').value = "";
            document.getElementById('modalTitle').textContent = `Nouveau ${currentView.toLowerCase()}`;
            document.getElementById('photoPreview').style.display = 'none'; document.getElementById('artPhotoData').value = "";
            const nameLabel = document.getElementById('formNameLabel'); const tiersFields = document.getElementById('tiers-only-fields'); const articleFields = document.getElementById('extra-article-fields');
            if(currentView === 'ARTICLE') {
                nameLabel.textContent = "Désignation de l'Article *"; tiersFields.style.display = 'none'; articleFields.style.display = 'grid'; updateSelects();
            } else { nameLabel.textContent = "Nom Complet / Raison Sociale *"; tiersFields.style.display = 'grid'; articleFields.style.display = 'none'; toggleLimitField(); }
            openModal('formModal');
        }

        function editItem(id) {
            const item = db[currentView].find(i => i.id === id);
            openAddForm(); document.getElementById('editId').value = item.id; document.getElementById('formName').value = item.name;
            if(currentView === 'ARTICLE') {
                document.getElementById('artFamily').value = item.family; document.getElementById('artSubFamily').value = item.subfamily;
                document.getElementById('artPrice').value = item.price; document.getElementById('artStock').value = item.stock;
                document.getElementById('artPhotoData').value = item.photo || "";
                if(item.photo) { document.getElementById('previewImg').src = item.photo; document.getElementById('photoPreview').style.display = 'block'; }
                calculateArticleValues();
            } else {
                document.getElementById('formPhone1').value = item.phone1; document.getElementById('formPhone2').value = item.phone2;
                document.getElementById('formAddress').value = item.address; document.getElementById('formStatus').value = item.status;
                document.getElementById('formLimit').value = item.limit; document.getElementById('formEmail').value = item.email; toggleLimitField();
            }
        }

        function handleSubmit(e) {
            e.preventDefault(); const editId = document.getElementById('editId').value;
            let payload = { name: document.getElementById('formName').value.trim() };
            if(currentView === 'ARTICLE') {
                payload = { ...payload, family: document.getElementById('artFamily').value, subfamily: document.getElementById('artSubFamily').value, price: parseFloat(document.getElementById('artPrice').value) || 0, stock: parseFloat(document.getElementById('artStock').value) || 0, photo: document.getElementById('artPhotoData').value };
            } else {
                payload = { ...payload, phone1: document.getElementById('formPhone1').value.trim(), phone2: document.getElementById('formPhone2').value.trim(), address: document.getElementById('formAddress').value.trim(), status: document.getElementById('formStatus').value, limit: parseFloat(document.getElementById('formLimit').value) || 0, email: document.getElementById('formEmail').value.trim().toLowerCase() };
            }
            const list = db[currentView];
            if(editId) { const idx = list.findIndex(i => i.id === editId); list[idx] = { ...list[idx], ...payload };
            } else {
                let prefix = currentView === 'CLIENT' ? 'CL-' : (currentView === 'FOURNISSEUR' ? 'FR-' : 'A-');
                list.push({ id: prefix + Date.now().toString().slice(-4), ...payload, date: new Date().toISOString().split('T')[0] });
            }
            saveData(); render(); closeModal('formModal'); showToast("Sauvegarde réussie");
        }

        // --- UTILITAIRES ---
        function toggleTheme() {
            const b = document.body; b.getAttribute('data-theme') === 'dark' ? b.removeAttribute('data-theme') : b.setAttribute('data-theme', 'dark');
            lucide.createIcons();
        }
        function saveData() {
            localStorage.setItem('crm_clients', JSON.stringify(db.CLIENT));
            localStorage.setItem('crm_suppliers', JSON.stringify(db.FOURNISSEUR));
            localStorage.setItem('crm_articles', JSON.stringify(db.ARTICLE));
            localStorage.setItem('crm_ventes', JSON.stringify(db.VENTE));
        }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function toggleLimitField() { const f = document.getElementById('formLimit'); const s = document.getElementById('formStatus').value; if(f) f.disabled = (s !== 'Abonné'); }
        function filterData() {
            const q = document.getElementById('searchInput').value.toLowerCase(); const data = db[currentView];
            render(data.filter(i => (i.name || i.clientName || '').toLowerCase().includes(q) || i.id.toLowerCase().includes(q)));
        }
        function exportData() {
            const list = db[currentView]; if(!list.length) return;
            let head, body;
            if(currentView === 'ARTICLE') {
                head = "Code;Designation;Famille;Prix;Stock\n"; body = list.map(i => `${i.id};${i.name};${i.family};${i.price};${i.stock}`).join("\n");
            } else if(currentView === 'VENTE') {
                head = "Num;Date;Tiers;Total;Reste\n"; body = list.map(i => `${i.num};${i.date};${i.clientName};${i.ttc};${i.reste}`).join("\n");
            } else {
                head = "Code;Nom;Contact;Adresse;Status\n"; body = list.map(i => `${i.id};${i.name};${i.phone1};${i.address};${i.status}`).join("\n");
            }
            const blob = new Blob([head + body], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a");
            link.href = URL.createObjectURL(blob); link.download = `Export_${currentView}_${new Date().toISOString().split('T')[0]}.csv`; link.click();
        }
        function showToast(msg, color = "#10b981") {
            const t = document.getElementById('toast'); t.textContent = msg; t.style.backgroundColor = color; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        window.onload = () => { render(); lucide.createIcons(); };
    </script>
</body>
</html>